---
import Layout from '@/layouts/Layout.astro';
import { z } from 'astro:content';

const CreateUserFormSchema = z
  .object({
    firstName: z.string().min(1, { message: '名前を入力してください' }),
    lastName: z.string().min(1, { message: '姓を入力してください' }),
    email: z
      .string()
      .email({ message: 'メールアドレスの形式ではありません' })
      .min(1, { message: 'メールアドレスを入力してください' }),
    zipcode: z.string().min(1, { message: '郵便番号を入力してください' }),
    prefecture: z.string().min(1, { message: '都道府県を入力してください' }),
    municipalities: z
      .string()
      .min(1, { message: '市区町村を入力してください' }),
    address: z.string().min(1, { message: '住所を入力してください' }),
    telephone: z.number().gte(1, { message: '電話番号を入力してください' }),
    password: z.string().min(1, { message: 'パスワードを入力してください' }),
    confirmationPassword: z
      .string()
      .min(1, { message: '確認用パスワードを入力してください' }),
  })
  .refine((data) => {
    data.password === data.confirmationPassword,
      {
        message: 'パスワードが一致していません',
        path: ['confiramtionPassword'],
      };
  });

if (Astro.request.method === 'POST') {
  const body = await Astro.request.formData().then((data) => {
    const obj: Record<string, string> = {};
    data.forEach((value, key) => {
      obj[key] = value.toString();
    });
    return obj;
  });

  const parsed = await CreateUserFormSchema.safeParse(body);
  // TODO(udonrm)サーバーとの連携を行う
  if (parsed.data != null) {
    console.log(parsed.data);
  }
}
---

<Layout title="新規会員登録">
  <form method="post" id="registerUser">
    <h1>新規会員登録</h1>

    <label for="firstName">姓</label>
    <input type="text" name="fistName" id="firstName" />

    <label for="lastName">名</label>
    <input type="text" name="lastName" id="lastName" />
    <br />

    <label for="email">メールアドレス</label>
    <input type="email" name="email" id="email" />
    <br />

    <label for="zipcode">郵便番号</label>
    <input type="text" name="zipcode" id="zipcode" /><br />

    <label for="prefecture">都道府県</label>
    <input type="text" name="prefecture" id="prefecture" /><br />

    <label for="municipalities">市区町村</label>
    <input type="text" name="municipalities" id="municipalities" /><br />

    <label for="address">住所</label>
    <input type="text" name="address" id="address" /><br />

    <label for="telephone">電話番号</label>
    <input type="tel" name="telephone" id="telephone" /><br />

    <label for="password">パスワード</label>
    <input type="password" name="password" id="password" /><br />

    <label for="confirmationPassword">確認用パスワード</label>
    <input
      type="password"
      name="confirmationPassword"
      id="confirmationPassword"
    />
    <br />

    <button type="submit">登録</button>
  </form>
</Layout>
